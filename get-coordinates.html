<!DOCTYPE html>
<html>
<head>
    <title>Get Current Location Coordinates</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
        .coordinates { font-size: 18px; font-weight: bold; color: #2196F3; }
        button { padding: 15px 30px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .info { margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üìç Get Your Current Location</h1>
    <button onclick="getLocation()">Get My Coordinates</button>
    <div id="result" class="info" style="display:none;">
        <h3>Your Current Coordinates:</h3>
        <div id="coordinates" class="coordinates"></div>
        <p><strong>Copy these coordinates and update your location.json file</strong></p>
    </div>
    <div id="error" style="display:none; color: red;"></div>

    <script>
        // Detect if user is on mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function getLocation() {
            const mobile = isMobile();
            document.getElementById("error").style.display = "none";
            document.getElementById("result").style.display = "none";
            
            if (navigator.geolocation) {
                // For production deployment, try IP location first for mobile
                if (mobile) {
                    console.log('üì± Mobile detected - trying IP location first...');
                    tryIPLocation().then(ipLocation => {
                        if (ipLocation) {
                            showIPPosition(ipLocation);
                        } else {
                            tryGPSLocation();
                        }
                    }).catch(() => tryGPSLocation());
                } else {
                    tryGPSLocation();
                }
            } else {
                document.getElementById("error").innerHTML = "Geolocation is not supported by this browser.";
                document.getElementById("error").style.display = "block";
            }
        }

        // IP-based location service for production
        async function tryIPLocation() {
            try {
                console.log('Attempting IP-based location...');
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                if (data.latitude && data.longitude) {
                    return {
                        lat: data.latitude,
                        lng: data.longitude,
                        accuracy: 10000,
                        source: 'IP Location'
                    };
                }
                return null;
            } catch (error) {
                console.log('IP location failed:', error);
                return null;
            }
        }

        function showIPPosition(ipData) {
            const mobile = isMobile();
            
            document.getElementById("coordinates").innerHTML = `
                <p><strong>Device:</strong> ${mobile ? "üì± Mobile" : "üíª Desktop"}</p>
                <p><strong>Location Source:</strong> ${ipData.source}</p>
                <p><strong>Latitude:</strong> ${ipData.lat}</p>
                <p><strong>Longitude:</strong> ${ipData.lng}</p>
                <p><strong>Accuracy:</strong> ~${ipData.accuracy} meters (IP-based)</p>
                <hr>
                <p><strong>For location.json:</strong></p>
                <code>"latitude": ${ipData.lat},<br>"longitude": ${ipData.lng}</code>
                <hr>
                <p><strong>Note:</strong></p>
                <small>‚ö†Ô∏è IP-based location is less accurate. For better accuracy, <button onclick="tryGPSLocation()" class="btn btn-sm btn-primary">Try GPS Location</button></small>
            `;
            document.getElementById("result").style.display = "block";
        }

        function tryGPSLocation() {
        function tryGPSLocation() {
            const mobile = isMobile();
            
            // Mobile-optimized settings
            const mobileOptions = {
                enableHighAccuracy: true,
                timeout: 30000, // Longer timeout for mobile
                maximumAge: 60000 // Allow 1-minute cached location
            };
            
            // Desktop settings
            const desktopOptions = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            const options = mobile ? mobileOptions : desktopOptions;
            
            console.log(`Using ${mobile ? 'mobile' : 'desktop'} GPS settings`);
            
            // Try high accuracy first
            navigator.geolocation.getCurrentPosition(showPosition, tryLowAccuracy, options);
        }
        }

        function tryLowAccuracy(error) {
            console.log("High accuracy failed, trying low accuracy...");
            const mobile = isMobile();
            
            // Even more lenient settings for mobile fallback
            const fallbackOptions = mobile ? {
                enableHighAccuracy: false,
                timeout: 20000,
                maximumAge: 300000 // 5 minutes for mobile
            } : {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 300000
            };
            
            navigator.geolocation.getCurrentPosition(showPosition, showError, fallbackOptions);
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const mobile = isMobile();
            
            // Assess accuracy quality (more lenient for mobile)
            let accuracyStatus = "";
            if (mobile) {
                if (accuracy <= 100) {
                    accuracyStatus = "üü¢ Excellent (Mobile)";
                } else if (accuracy <= 500) {
                    accuracyStatus = "üü° Good (Mobile)";
                } else if (accuracy <= 2000) {
                    accuracyStatus = "üü† Fair (Mobile)";
                } else {
                    accuracyStatus = "üî¥ Poor (Mobile)";
                }
            } else {
                if (accuracy <= 50) {
                    accuracyStatus = "üü¢ Excellent";
                } else if (accuracy <= 200) {
                    accuracyStatus = "üü° Good";
                } else if (accuracy <= 1000) {
                    accuracyStatus = "üü† Fair";
                } else {
                    accuracyStatus = "üî¥ Poor";
                }
            }
            
            // Mobile-specific recommendations
            let recommendation = "";
            if (mobile) {
                if (accuracy <= 500) {
                    recommendation = "‚úÖ Good accuracy for mobile attendance";
                } else if (accuracy <= 2000) {
                    recommendation = "‚ö†Ô∏è Try moving outside or near a window for better GPS signal";
                } else {
                    recommendation = "‚ùå Poor GPS signal. Go outside and wait 30 seconds, then try again";
                }
            } else {
                recommendation = accuracy <= 200 ? "‚úÖ Good accuracy for attendance" : "‚ö†Ô∏è Try refreshing for better location";
            }
            
            document.getElementById("coordinates").innerHTML = `
                <p><strong>Device:</strong> ${mobile ? "üì± Mobile" : "üíª Desktop"}</p>
                <p><strong>Latitude:</strong> ${lat}</p>
                <p><strong>Longitude:</strong> ${lng}</p>
                <p><strong>Accuracy:</strong> ${accuracy} meters ${accuracyStatus}</p>
                <hr>
                <p><strong>For location.json:</strong></p>
                <code>"latitude": ${lat},<br>"longitude": ${lng}</code>
                <hr>
                <p><strong>Recommendation:</strong></p>
                <small>${recommendation}</small>
                ${mobile && accuracy > 1000 ? '<br><small><strong>üì± Mobile Tips:</strong> Enable high accuracy GPS, go outside, wait for better signal</small>' : ''}
            `;
            document.getElementById("result").style.display = "block";
        }

        function showError(error) {
            let errorText = "";
            const mobile = isMobile();
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorText = "‚ùå User denied the request for Geolocation. Please allow location access.";
                    if (mobile) {
                        errorText += "<br><small>üì± Mobile: Check browser location permissions and device location settings</small>";
                    }
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorText = "‚ùå Location information is unavailable.";
                    if (mobile) {
                        errorText += "<br><small>üì± Mobile: Move outside or near a window. Check if GPS is enabled.</small>";
                    }
                    break;
                case error.TIMEOUT:
                    errorText = "‚ùå The request to get user location timed out.";
                    if (mobile) {
                        errorText += "<br><small>üì± Mobile: GPS signal is weak. Try going outside and waiting 30 seconds.</small>";
                    }
                    break;
                default:
                    errorText = "‚ùå An unknown error occurred.";
                    break;
            }
            
            // Add troubleshooting tips
            errorText += `
                <hr>
                <p><strong>Troubleshooting for ${mobile ? "üì± Mobile Devices" : "üíª Desktop"}:</strong></p>
                <ul style="text-align: left; font-size: 12px;">
                    ${mobile ? `
                        <li>Enable high accuracy GPS in device settings</li>
                        <li>Allow location access in browser settings</li>
                        <li>Move outside or near a window</li>
                        <li>Wait 30+ seconds for GPS signal</li>
                        <li>Check if location services are enabled for browser</li>
                    ` : `
                        <li>Allow location access in browser</li>
                        <li>Check browser location permissions</li>
                        <li>Try refreshing the page</li>
                        <li>Ensure WiFi location services are enabled</li>
                    `}
                </ul>
            `;
            
            document.getElementById("error").innerHTML = errorText;
            document.getElementById("error").style.display = "block";
        }
    </script>
</body>
</html>
